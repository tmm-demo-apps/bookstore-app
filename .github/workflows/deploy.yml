name: Deploy

on:
  # Trigger after CI completes successfully on main
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  
  # Allow manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.0). Leave empty for auto-generated tag.'
        required: false
        type: string

jobs:
  deploy:
    name: Build and Push to Harbor
    runs-on: ubuntu-latest
    # Only run if CI succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Free up disk space
      run: |
        echo "Before cleanup:"
        df -h
        
        # Remove unnecessary packages
        sudo apt-get remove -y '^dotnet-.*' '^llvm-.*' 'php.*' '^mongodb-.*' '^mysql-.*' azure-cli google-chrome-stable firefox powershell mono-devel libgl1-mesa-dri || true
        sudo apt-get autoremove -y
        sudo apt-get clean
        
        # Remove large directories
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL || true
        
        # Clean docker
        docker system prune -af --volumes || true
        
        echo "After cleanup:"
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Generate version tag
      id: version
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          # Manual trigger with version
          VERSION="${{ github.event.inputs.version }}"
        else
          # Auto-generate version from date and short SHA
          VERSION="v$(date +'%Y%m%d')-${GITHUB_SHA::7}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "Generated version: ${VERSION}"

    - name: Login to Harbor
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.HARBOR_URL }}
        username: ${{ secrets.HARBOR_USERNAME }}
        password: ${{ secrets.HARBOR_PASSWORD }}

    - name: Build and Push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }}
          ${{ secrets.HARBOR_URL }}/bookstore/app:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        platforms: linux/amd64

    - name: Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image pushed to Harbor:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.HARBOR_URL }}/bookstore/app:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
        echo "- Argo CD will automatically sync the new image, OR" >> $GITHUB_STEP_SUMMARY
        echo "- Manually update: \`kubectl set image deployment/app-deployment bookstore-app=${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }} -n bookstore\`" >> $GITHUB_STEP_SUMMARY

  # Optional: Notify on failure
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment workflow failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY

name: Deploy

on:
  # Trigger after CI completes successfully on main
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]
  
  # Allow manual trigger with version input
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.2.0). Leave empty for auto-generated tag.'
        required: false
        type: string

jobs:
  deploy:
    name: Tag and Push to Harbor
    # Use same self-hosted runner (image already built by CI)
    runs-on: [self-hosted, linux, harbor]
    # Only run if CI succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Fetch latest to get CI's kustomization.yaml update
        ref: main

    - name: Get version tag from kustomization.yaml
      id: version
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          # Manual trigger with explicit version
          VERSION="${{ github.event.inputs.version }}"
          echo "Using manual version: ${VERSION}"
        else
          # Read tag from kustomization.yaml (set by CI workflow)
          VERSION=$(grep -A1 'harbor.corp.vmbeans.com/bookstore/app' kubernetes/kustomization.yaml | grep newTag | awk '{print $2}')
          if [ -z "$VERSION" ]; then
            echo "âŒ Could not read version from kustomization.yaml"
            exit 1
          fi
          echo "Read version from kustomization.yaml: ${VERSION}"
        fi
        echo "version=${VERSION}" >> $GITHUB_OUTPUT

    - name: Check for existing image
      id: check_image
      run: |
        # Check if CI already built the image
        if docker image inspect bookstore-app:${{ github.sha }} > /dev/null 2>&1; then
          echo "found=true" >> $GITHUB_OUTPUT
          echo "âœ… Found existing image: bookstore-app:${{ github.sha }}"
        else
          echo "found=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Image not found, will build fresh"
        fi

    - name: Build Docker image (if not cached)
      if: steps.check_image.outputs.found != 'true'
      run: |
        echo "Building fresh Docker image..."
        docker build -t bookstore-app:${{ github.sha }} .
        docker tag bookstore-app:${{ github.sha }} bookstore-app:latest

    - name: Login to Harbor
      run: |
        echo "${{ secrets.HARBOR_PASSWORD }}" | docker login ${{ secrets.HARBOR_URL }} -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin

    - name: Tag and Push to Harbor
      run: |
        # Tag for Harbor
        docker tag bookstore-app:${{ github.sha }} ${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }}
        docker tag bookstore-app:${{ github.sha }} ${{ secrets.HARBOR_URL }}/bookstore/app:latest
        
        # Push to Harbor
        echo "Pushing ${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }}..."
        docker push ${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }}
        
        echo "Pushing ${{ secrets.HARBOR_URL }}/bookstore/app:latest..."
        docker push ${{ secrets.HARBOR_URL }}/bookstore/app:latest

    - name: Summary
      run: |
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image pushed to Harbor:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ secrets.HARBOR_URL }}/bookstore/app:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Info:**" >> $GITHUB_STEP_SUMMARY
        echo "- Git SHA: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- Image reused from CI: ${{ steps.check_image.outputs.found }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
        echo "- Argo CD will automatically sync the new image, OR" >> $GITHUB_STEP_SUMMARY
        echo "- Manually update: \`kubectl set image deployment/app-deployment bookstore-app=${{ secrets.HARBOR_URL }}/bookstore/app:${{ steps.version.outputs.version }} -n bookstore\`" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup old images
      run: |
        # Keep only recent images to save disk space
        docker image prune -f --filter "until=24h" || true
